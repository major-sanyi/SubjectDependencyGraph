@using SubjectDependencyGraph.Blazor.Resources
@using SubjectDependencyGraph.Shared.Models

<MudDataGrid T="KeyValuePair<Subject,bool>" Items="Subjects"
             ReadOnly="ReadOnly" Virtualize=true EditMode="DataGridEditMode.Cell"
             RowStyleFunc="@_rowStyleFunc" Groupable=true>
    <Columns>
        <PropertyColumn Property="x=>x.Key.Id" Title="@AppStrings.Subject_Id"></PropertyColumn>
        <PropertyColumn Property="x=>x.Key.Name" Title="@AppStrings.Subject_Name"></PropertyColumn>
        <PropertyColumn Property="x=>x.Key.Kredit" Title="@AppStrings.Subject_Kredit"></PropertyColumn>
        <PropertyColumn Property="x=>x.Key.RecommendedSemester" Title="@AppStrings.Subject_RecommendedSemester"></PropertyColumn>
        <PropertyColumn Property="x=>x.Key.Language" Title="@AppStrings.Subject_Language"></PropertyColumn>
        <PropertyColumn SortBy="x=>x.Key.PreRequisiteSubjectsSolved.Any()" Filterable="false" Sortable="false" Property="x=>x.Key.PreRequisiteSubjectsSolved" Title="@AppStrings.Subject_PreRequisiteSubjects">
            <EditTemplate>
                <MudSelect T="Subject" MultiSelection="true" SelectedValuesChanged="@(x=>HandleSelectedValuesChanged(x,context.Item.Key ))" SelectedValues="context.Item.Key.PreRequisiteSubjectsSolved">
                    @if (Subjects is not null)
                        @foreach (var item in (Subjects.Keys))
                        {
                            @if (item.Id != context.Item.Key.Id)
                            {
                                <MudSelectItem T="Subject" Value="@item">@item</MudSelectItem>
                            }
                        }
                </MudSelect>
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x=>x.Key.Finished" Title="@AppStrings.Subject_Finished">
            <EditTemplate>
                <MudCheckBox @bind-Value="context.Item.Key.Finished" />
            </EditTemplate>
        </PropertyColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager />
    </PagerContent>
</MudDataGrid>

@code {
    [Parameter]
    public Dictionary<Subject, bool>? Subjects { get; set; }

    [Parameter]
    public bool ReadOnly { get; set; } = false;

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }
    private void HandleSelectedValuesChanged(IEnumerable<Subject> changedValues, Subject subject)
    {
        subject.PreRequisiteSubjectsSolved = new HashSet<Subject>(changedValues);
    }
    private Func<KeyValuePair<Subject, bool>, int, string> _rowStyleFunc => (x, i) =>
    {
        if (x.Value == true)
        {
            return $"background-color:{Colors.DeepPurple.Lighten5};";

        }

        return "";
    };
}
